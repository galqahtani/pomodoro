<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pomodoro</title>
  <meta name="color-scheme" content="dark light" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#0b0b0c; --fg:#ffffff; --muted:#b7b7c0; --accent:#2f54ff;
      --border:#ffffff26; --panel:#121219; --input:#0f0f16;
    }
    html,body{height:100%}
    body{margin:0;display:grid;place-items:center;min-height:100dvh;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{width:min(900px,92vw);text-align:center}

    .tabs{display:flex;gap:18px;justify-content:center;margin-top:42px;margin-bottom:28px}
    .tab{border:1.5px solid var(--border);color:var(--fg);padding:12px 18px;border-radius:999px;font-weight:600;letter-spacing:.2px;background:transparent;cursor:pointer;transition:transform .06s ease,border-color .15s ease,background .2s}
    .tab:hover{transform:translateY(-1px)}
    .tab.active{background:#ffffff0f;border-color:#ffffff40}

    .time{font-weight:800;font-size:clamp(56px,14vw,160px);line-height:1;letter-spacing:2px;margin:18px 0 26px}

    .controls{display:flex;gap:18px;justify-content:center;align-items:center}
    .btn{border:none;border-radius:999px;padding:16px 28px;font-weight:800;font-size:18px;cursor:pointer;transition:transform .05s ease,background .2s,opacity .2s}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:#fff;color:#111}
    .btn-ghost{background:transparent;color:var(--fg);border:2px solid var(--border);padding:12px 16px;border-radius:999px}
    .icon-btn{width:48px;height:48px;display:grid;place-items:center;border-radius:50%;border:2px solid var(--border);background:transparent;color:var(--fg);cursor:pointer;font-size:22px}

    .progress{display:none}

    /* Settings dialog – cleaned layout */
    dialog{border:none;border-radius:16px;padding:0;background:var(--panel);color:var(--fg);width:min(560px,92vw)}
    .sheet{display:flex;justify-content:space-between;align-items:center;padding:18px 18px;border-bottom:1px solid #ffffff12}
    .sheet h3{margin:0;font-weight:800}
    .content{padding:18px}
    .form{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    .form .full{grid-column:1/-1}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px 2px}
    input[type="number"],select{width:100%;padding:12px;border-radius:12px;border:1px solid #ffffff1e;background:var(--input);color:var(--fg);font-size:16px}
    .check{display:flex;align-items:center;gap:10px;padding:10px 0}
    .actions{display:flex;gap:10px;justify-content:flex-end;padding:14px 18px;border-top:1px solid #ffffff12}
    .small{font-size:12px;color:#a6a6b4;margin-top:8px}
    *{box-sizing:border-box}
    @media (max-width: 600px){ .form{grid-template-columns:1fr 1fr} }
    @media (max-width: 420px){ .form{grid-template-columns:1fr} }
    .actions{display:flex;gap:10px;justify-content:flex-end;padding:14px 18px;border-top:1px solid #ffffff12;flex-wrap:wrap}
    .actions .btn{min-width:110px}
  </style>
</head>
<body>
  <div class="progress" id="progress"></div>
  <main class="wrap">
    <div class="tabs" role="tablist" aria-label="Modes">
      <button class="tab active" data-mode="pomodoro" aria-selected="true">pomodoro</button>
      <button class="tab" data-mode="short">short break</button>
      <button class="tab" data-mode="long">long break</button>
    </div>

    <div class="time" id="time" aria-live="polite">25:00</div>

    <div class="controls" aria-label="Controls">
      <button id="startPause" class="btn btn-primary">start</button>
      <button id="reset" class="icon-btn" title="Reset" aria-label="Reset">⟳</button>
      <button id="settingsBtn" class="icon-btn" title="Settings" aria-label="Settings">⚙</button>
    </div>

    <p class="small" style="opacity:.8;margin-top:18px">Space: start/pause · R: reset · 1/2/3: switch modes</p>
  </main>

  <!-- Settings Modal -->
  <dialog id="settings">
    <div class="sheet">
      <h3>Settings</h3>
      <button id="closeSettings" class="icon-btn" aria-label="Close">✕</button>
    </div>
    <div class="content">
      <div class="form">
        <div>
          <label for="pomoMin">Pomodoro (min)</label>
          <input id="pomoMin" type="number" min="1" max="180" step="1" />
        </div>
        <div>
          <label for="shortMin">Short break (min)</label>
          <input id="shortMin" type="number" min="1" max="60" step="1" />
        </div>
        <div>
          <label for="longMin">Long break (min)</label>
          <input id="longMin" type="number" min="1" max="90" step="1" />
        </div>
        <div class="full check">
          <input id="autoShort" type="checkbox" />
          <label for="autoShort" style="margin:0">Auto-start short break after Pomodoro</label>
        </div>
        <div class="full check">
          <input id="autoNext" type="checkbox" />
          <label for="autoNext" style="margin:0">Auto-start next session (toggle between focus/break)</label>
        </div>
        <div class="full">
          <label for="soundSelect">Completion sound</label>
          <select id="soundSelect">
            <option value="none">None</option>
            <option value="chime">Soft Chime</option>
            <option value="bell">Bell</option>
          </select>
        </div>
      </div>
      <p class="small">Preferences save locally in this browser.</p>
    </div>
    <div class="actions">
      <button id="save" class="btn btn-primary">Save</button>
      <button id="cancel" class="btn btn-ghost">Cancel</button>
    </div>
  </dialog>

  <!-- Embedded reliable sounds (small, offline-safe) -->
  <audio id="chimeSound" preload="auto" src="data:audio/wav;base64,UklGRp4AAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YZQAAABsAAAAPwAANQAALwAAMQAAWgAAYgAAXwAAUwAAOQAAJwAAIQAALQAAQQAAXwAAaQAAZQAAWgAAQwAAKgAAHgAAJwAAOwAATwAAXAAAXQAAXQAAXAAATgAARgAAQgAAQgAARgAATgAAXAAAXQAAWwAAUQAAPgAAKgAAHAAAHwAAKwAAPwAARQAATwAAWAAAagAAbwAAaAAAWgAATwAARAAAOgAANwAAOgAARAAATwAAWgAAaAAAbwAAagAAWAAAUwAATwAARQAAPwAAKwAAHwAAHAAA" ></audio>
  <audio id="bellSound" preload="auto" src="data:audio/wav;base64,UklGRsYAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YaQAAABqAAAAUAAAOgAAKwAAJgAAKwAAOgAATgAAVwAAWwAAVwAATgAAOgAAKwAAJgAAKwAAOgAATgAAVwAAWwAAVwAATgAAOgAAKwAAJgAAKwAAOgAATgAAVwAAWwAAVwAATgAAOgAAKwAAJgAAKwAAOgAATgAAVwAAWwAAVwAATgAAOgAAKwAAJgAAKwAA" ></audio>

  <script>
    const el = (id)=>document.getElementById(id);
    const $time = el('time');
    const $startPause = el('startPause');
    const $reset = el('reset');
    const $progress = el('progress');

    const DFLT = { pomodoro:25, short:5, long:15, autoNext:false, autoShort:true, sound:"chime" };
    const store = { key:'pomo:v4', get(){ try{return {...DFLT,...(JSON.parse(localStorage.getItem(this.key))||{})};}catch{return {...DFLT};} }, set(v){ localStorage.setItem(this.key, JSON.stringify(v)); } };

    let prefs = store.get();
    let mode='pomodoro';
    let remaining=prefs.pomodoro*60; let total=remaining; let timer=null; let running=false;

    const fmt=s=>{const m=Math.floor(s/60).toString().padStart(2,'0');const sec=Math.floor(s%60).toString().padStart(2,'0');return `${m}:${sec}`};
    const updateDisplay=()=>{ $time.textContent=fmt(remaining); document.title=`${fmt(remaining)} • ${mode}`; $progress.style.width=`${((total-remaining)/total)*100}%`; };
    const setMode=m=>{ mode=m; total=(prefs[m]||25)*60; remaining=total; document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('active',b.dataset.mode===m)); stop(); updateDisplay(); };

    const tick=()=>{ if(remaining>0){ remaining--; updateDisplay(); } else { complete(); } };
    const start=()=>{ if(running) return; running=true; $startPause.textContent='pause'; timer=setInterval(tick,1000); };
    const stop =()=>{ running=false; clearInterval(timer); timer=null; $startPause.textContent='start'; };
    const reset=()=>{ remaining=total; updateDisplay(); };

    function playSound(){
      if(prefs.sound==='none') return;
      const node = prefs.sound==='bell' ? el('bellSound') : el('chimeSound');
      try{ node.currentTime=0; node.play(); }catch{ /* fallback to WebAudio if needed */ try{ const a=new (window.AudioContext||window.webkitAudioContext)(); const o=a.createOscillator(); const g=a.createGain(); o.type='sine'; o.frequency.value = prefs.sound==='bell'? 880:660; o.connect(g); g.connect(a.destination); g.gain.setValueAtTime(0.001,a.currentTime); g.gain.exponentialRampToValueAtTime(0.2,a.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.0001,a.currentTime+0.4); o.start(); o.stop(a.currentTime+0.42);}catch{}}
    }

    function complete(){
      stop(); remaining=0; updateDisplay(); playSound();
      if(prefs.autoShort && mode==='pomodoro'){ setMode('short'); start(); return; }
      if(prefs.autoNext){ const next = mode==='pomodoro' ? 'short' : 'pomodoro'; setMode(next); start(); }
    }

    // Prime audio on first user gesture so playback is allowed
    const prime=()=>{ ['chimeSound','bellSound'].forEach(id=>{ const n=el(id); n.volume=0; n.play().then(()=>{ n.pause(); n.currentTime=0; n.volume=1; }).catch(()=>{}); }); document.removeEventListener('click',prime); };
    document.addEventListener('click',prime,{once:true});

    // UI wiring
    document.querySelectorAll('.tab').forEach(btn=>btn.addEventListener('click',()=>setMode(btn.dataset.mode)));
    $startPause.addEventListener('click',()=>running?stop():start());
    $reset.addEventListener('click',()=>{ stop(); reset(); });

    // Keyboard shortcuts
    window.addEventListener('keydown',e=>{ if(e.target.closest('dialog')) return; if(e.code==='Space'){ e.preventDefault(); running?stop():start(); } if(e.key==='r'||e.key==='R'){ stop(); reset(); } if(e.key==='1') setMode('pomodoro'); if(e.key==='2') setMode('short'); if(e.key==='3') setMode('long'); });

    // Dialog controls
    const $dlg = el('settings');
    const openSettings = ()=>{ el('pomoMin').value=prefs.pomodoro; el('shortMin').value=prefs.short; el('longMin').value=prefs.long; el('autoNext').checked=!!prefs.autoNext; el('autoShort').checked=!!prefs.autoShort; el('soundSelect').value=prefs.sound; $dlg.showModal(); };
    const closeSettings = ()=> $dlg.close();
    el('settingsBtn').addEventListener('click',openSettings);
    el('closeSettings').addEventListener('click',closeSettings);
    el('cancel').addEventListener('click',closeSettings);
    $dlg.addEventListener('click',e=>{ if(e.target===$dlg) closeSettings(); });
    window.addEventListener('keydown',e=>{ if(e.key==='Escape' && $dlg.open) closeSettings(); });

    el('save').addEventListener('click',()=>{
      prefs={ pomodoro:Math.max(1,Math.min(180,parseInt(el('pomoMin').value)||25)), short:Math.max(1,Math.min(60,parseInt(el('shortMin').value)||5)), long:Math.max(1,Math.min(90,parseInt(el('longMin').value)||15)), autoNext:!!el('autoNext').checked, autoShort:!!el('autoShort').checked, sound:el('soundSelect').value };
      store.set(prefs); total=prefs[mode]*60; remaining=total; updateDisplay(); closeSettings(); });

    setMode('pomodoro'); updateDisplay();
  </script>
</body>
</html>
